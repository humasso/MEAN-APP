(function () {

    'use strict';

    var API = require('../scripts/API'),

        url = require('url'),
        request = require('request'),
        WebSocket = require('ws'),

        corsApiProcessor = new API();

    corsApiProcessor.setRule(':url');

    corsApiProcessor.wsProxy = function wsProxy (data) {
        var ws = new WebSocket(data.callData.params.url);
        ws.on('open', function () {
            ws.send(data.callData.params.data);
        });
        ws.on('message', function (message) {
            data.socket.send(message);
        });
    };

    corsApiProcessor.on('call', function (data) {
        if (data.type === 'http') {
            if (data.params.url && data.params.url.length) {
                if (!~data.params.url.indexOf('http')) {
                    data.params.url = 'http://' + data.params.url;
                }
                data.request.pipe(request(data.params.url)).pipe(data.response);
            } else {
                data.response.writeHead(404);
                data.response.end();
            }
        } else if (data.type === 'ws') {

        }
    });

    module.exports = corsApiProcessor;

}());
